@startuml
title 任务执行时序（RunTask → Python Engine → 状态轮询/日志 → 完成/取消/超时）

skinparam shadowing false
skinparam ArrowColor #444
skinparam DefaultFontName Microsoft YaHei

actor User
participant "Wails UI" as UI
participant "Go Backend\n(Wails bindings)" as API
participant "Task Service" as TS
participant "Task Registry" as REG
participant "Task Queue" as Q
participant "Worker/Runner" as RUN
participant "Python Engine\n(engine_main.py)" as PY
database "Filesystem\n(output_dir)" as FS

== 提交任务 ==
User -> UI : 选择文件/参数\n点击开始
UI -> API : RunTask(request)
API -> TS : validate + create task_id
TS -> REG : status=pending
TS -> Q : enqueue(task_id)
API --> UI : return task_id

== 调度执行 ==
RUN -> Q : take task
RUN -> REG : status=running
RUN -> FS : create workspace
RUN -> PY : spawn process\nsend request JSON
activate PY

== 引擎执行与输出 ==
PY -> FS : read input
PY -> FS : write artifacts\n(result.csv, summary.json, plots.json)
PY --> RUN : stdout response JSON
PY --> RUN : stderr logs/progress (stream)
deactivate PY

RUN -> REG : status=succeeded/failed\nstore artifacts/error
RUN --> TS : notify completion (optional)

== UI 轮询状态 ==
loop every 200~500ms
  UI -> API : GetTaskStatus(task_id)
  API -> REG : read status + logs + artifacts
  REG --> API
  API --> UI : status + logs + artifacts
end

== 取消（可选） ==
opt User clicks Cancel
  User -> UI : 点击取消
  UI -> API : CancelTask(task_id)
  API -> TS : cancel request
  TS -> REG : mark cancel_requested
  TS -> RUN : signal kill/interrupt
  RUN -> PY : terminate process
  RUN -> REG : status=canceled
end

== 超时（可选） ==
opt Timeout triggered
  TS -> RUN : timeout signal
  RUN -> PY : kill process
  RUN -> REG : status=timed_out
end
@enduml
